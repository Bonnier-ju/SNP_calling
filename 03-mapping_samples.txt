#!/bin/bash
#SBATCH -p workq
#SBATCH --time=48:00:00 #job time limit
#SBATCH -J 03-mapping_samples #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=24G #memory reservation
#SBATCH --cpus-per-task=6 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL

# Clean work place 
module purge

# Charger les modules n√©cessaires 
module load bioinfo/bwa-mem2/2.2.1
module load bioinfo/samtools/1.19

# Move to the directory containing files
cd /work/user/jbonnier/Dicorynia/full_workflow/02-filtering_reads/ 

# Reference genome
REF=~/work/Dicorynia/Raw_data/Dgu_HS1_HYBRID_SCAFFOLD.fa

# Creating an array of sample names
INDS=($(for i in ~/work/Dicorynia/full_workflow/02-filtering_reads/*.trimmed.fastq.gz; do
    base=$(basename "$i")
    echo "${base%%.R[12].trimmed.fastq.gz}" 
done | uniq))


# Declare variables for forward and reverse reads and output
for IND in "${INDS[@]}"; do
  FORWARD=~/work/Dicorynia/full_workflow/02-filtering_reads/${IND}.R1.trimmed.fastq.gz
  REVERSE=~/work/Dicorynia/full_workflow/02-filtering_reads/${IND}.R2.trimmed.fastq.gz
  OUTPUT=~/work/user/jbonnier/Dicorynia/full_workflow/03-mapping/${IND}_sort.bam


  # Extract the ID part from the filename
  ID_PART1=$(echo "$IND" | cut -d '_' -f 4)
  ID_PART2=$(echo "$IND" | cut -d '_' -f 2)
  ID_PART3=$(echo "$IND" | cut -d '_' -f 3)
  
  
  # Define the read group with the extracted ID
  RG="@RG\tID:${ID_PART1}\tSM:${ID_PART2}\tPL:illumina\tLB:${ID_PART3}_lib"



  # Align and sort
  echo "Aligning $IND with bwa"
  bwa-mem2 mem -M -R "$RG" -t ${SLURM_CPUS_PER_TASK} $REF $FORWARD $REVERSE | \
  samtools view -b | \
  samtools sort -o $OUTPUT

  echo "Mapping and sorting completed for: $IND"
done
