#!/bin/bash
#SBATCH -p workq
#SBATCH --time=20:00:00 #job time limit
#SBATCH -J 07.1-filtration_by_LD #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=30G #memory reservation
#SBATCH --cpus-per-task=10 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL

echo "Starting filtration by LD"

# Clean the work environment
module purge

#Module load
module load bioinfo/PLINK/1.90b7
module load bioinfo/samtools/1.19
module load bioinfo/Bcftools/1.9

# Define file paths
PLINK_FILE="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.3-missing_filtering/missing_0_SNP/0_missing_SNP"
OUTPUT_DIR="/work/user/jbonnier/Dicorynia/full_workflow/06-population_genetic/06.0-data_preparation/06.0.1-LD_pruning/"

# Step 1: Calculate LD using plink
plink --bfile $PLINK_FILE \
	--r2 \
	--ld-window-kb 10000 \
	--ld-window-r2 0.8 \
	--allow-extra-chr \
	--out $OUTPUT_DIR/ld_results

# Step 2: Filter SNPs based on LD
# Assume a specific logic to filter SNPs based on the LD results file

awk '$5 >= 0.8 { print $3 }' $OUTPUT_DIR/ld_results.ld > $OUTPUT_DIR/filtered_snps_list.txt

#Fitering double SNPs
sort $OUTPUT_DIR/filtered_snps_list.txt | uniq > $OUTPUT_DIR/filtered_snps_list_unique.txt


# Step 3: Extract the filtered SNPs to create a new PLINK file using plink
plink --bfile $PLINK_FILE \
	--extract $OUTPUT_DIR/filtered_snps_list_unique.txt \
	--make-bed \
	--allow-extra-chr \
	--export vcf \
	--out $OUTPUT_DIR/pruned_snp

# Step 4: Count the number of remaining SNPs
echo "Counting the number of remaining SNPs..."
SNP_COUNT=$(wc -l < $OUTPUT_DIR/pruned_snp.bim)
echo "Number of SNPs after filtering: $SNP_COUNT"

echo "LD calculation and SNP filtering completed."

# Step 5: Compress the resulting VCF file
echo "Compressing the VCF file..."
bgzip -c $OUTPUT_DIR/pruned_snp.vcf > $OUTPUT_DIR/pruned_snp.vcf.gz