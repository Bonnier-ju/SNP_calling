#!/bin/bash
#SBATCH -p workq
#SBATCH --time=20:00:00 #job time limit
#SBATCH -J 07.1.1-FST_windows #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=30G #memory reservation
#SBATCH --cpus-per-task=10 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL

echo "Starting filtration by FST"

# Clean the work environment
module purge

#Module load
module load bioinfo/samtools/1.14
module load bioinfo/VCFtools/0.1.16
module load bioinfo/Bcftools/1.9

# Define the path
VCF_FILE="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-filtration_by_LD/West_East_filtered_LD_0.8_SNP.vcf"
VCF_FILE_GZ="${VCF_FILE}.gz"
FILE_East="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-sweep_processing_01/07.1.1-Fst_windows/East_pop.txt"
FILE_West="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-sweep_processing_01/07.1.1-Fst_windows/West_pop.txt"
OUTPUT_DIR="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-sweep_processing_01/07.1.1-Fst_windows/"

# Compress the VCF file with bgzip
bgzip -c $VCF_FILE > $VCF_FILE_GZ

# Index the compressed VCF file with tabix
tabix -p vcf $VCF_FILE_GZ

# Calculate Fst using VCFtools with 100kb sliding windows and a 10kb step size
vcftools --gzvcf $VCF_FILE_GZ \
    --weir-fst-pop $FILE_East --weir-fst-pop $FILE_West \
    --fst-window-size 100000 \
    --fst-window-step 10000 \
    --out ${OUTPUT_DIR}/East_vs_West_fst_results

# Sort the Fst results to get the top 5%
sort -k3,3nr ${OUTPUT_DIR}/East_vs_West_fst_results.windowed.weir.fst | head -n $(($(wc -l < ${OUTPUT_DIR}/East_vs_West_fst_results.windowed.weir.fst) * 5 / 100)) > ${OUTPUT_DIR}/top_5_percent_fst.txt

# Extract SNPs from the specified regions and add them to a VCF file
bcftools view -h $VCF_FILE_GZ > ${OUTPUT_DIR}/filtered_FST_5percent_snps.vcf
while IFS=$'\t' read -r chrom start end n_variants weighted_fst mean_fst; do
    bcftools view -H -r ${chrom}:${start}-${end} $VCF_FILE_GZ >> ${OUTPUT_DIR}/filtered_FST_5percent_snps.vcf
done < ${OUTPUT_DIR}/top_5_percent_fst.txt

echo "Extraction of SNPs from top 5% Fst regions completed."

# Count the number of SNPs in the final VCF file
SNP_COUNT=$(grep -vc "^#" ${OUTPUT_DIR}/filtered_FST_5percent_snps.vcf)
echo "Number of SNPs in the final VCF file: $SNP_COUNT"


