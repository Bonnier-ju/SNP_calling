#!/bin/bash
#SBATCH -p workq 
#SBATCH --time=5:00:00 #job time limit
#SBATCH -J 00.6-Plink_to_BayPass #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=5G #memory reservation
#SBATCH --cpus-per-task=2 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL

echo "Starting conversion to BayPass file"

# Clean the work environment
module purge

#Module load
module load bioinfo/PLINK/1.90b7

#File path
METADATA="/work/user/jbonnier/Dicorynia/full_workflow/06-population_structure/Pop_file.txt"
PLINK_FILE="/work/user/jbonnier/Dicorynia/full_workflow/01-random_stuff/01.2-converting_files/00.6-Plink_to_BayPass/full_SNP"
OUTPUT_MID="/work/user/jbonnier/Dicorynia/full_workflow/01-random_stuff/01.2-converting_files/00.6-Plink_to_BayPass/freq_count"
F_OUTPUT="/work/user/jbonnier/Dicorynia/full_workflow/08-EAA/08.1-BayPass/SNP_baypass.txt"


cd /work/user/jbonnier/Dicorynia/full_workflow/01-random_stuff/01.2-converting_files/00.6-Plink_to_BayPass/

# Create a backup of the original PLINK .ped file
cp ${PLINK_FILE}.ped ${PLINK_FILE}_backup.ped

#remove first 2 columns
awk '{$1=$2=""; print $0}' ${PLINK_FILE}_backup.ped > x.delete

# Create modified .ped for PLINK analysis, avoiding overwriting original .ped
paste $METADATA x.delete > ${PLINK_FILE}_modified.ped

#supress table in file 
sed -i 's/\t/ /g' ${PLINK_FILE}_modified.ped

#Run the population-based allele frequency calculations
echo "Run population-based allele frequency"
plink --file ${PLINK_FILE}_modified --allow-extra-chr --freq counts --out $OUTPUT_MID

# Assurez-vous que le fichier de fréquences correct est utilisé
if [ ! -f "${OUTPUT_MID}/freq_count.frq.counts" ]; then
    echo "PLINK frequency output not found at ${OUTPUT_MID}/freq_count.frq.counts. Exiting."
    exit 1
else
    echo "PLINK frequency output found, proceeding with data manipulation."
fi

# Adaptez cette commande pour manipuler le fichier de sortie correct
tail -n +2 ${OUTPUT_MID}/freq_count.frq.counts | awk '{print $5, $6 - $5}' | tr "\n" " " | sed 's/ /\n/6; P; D' > $F_OUTPUT

# Vérification que le fichier formaté pour BayPass a été correctement créé
if [ ! -f $F_OUTPUT ]; then
    echo "Failed to create BayPass formatted output file."
    exit 1
else
    echo "BayPass formatted output file successfully created."
fi

echo "End of converting to BayPass format"

