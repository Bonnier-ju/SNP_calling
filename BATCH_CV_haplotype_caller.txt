#!/bin/bash
#SBATCH -p workq
#SBATCH --time=01:00:00 #job time limit
#SBATCH -J mapping #job name
#SBATCH -o output.out #output file name
#SBATCH -e error.out #error file name
#SBATCH --mem=20G #memory reservation
#SBATCH --cpus-per-task=4 #ncpu on the same node
#SBATCH --mail-type=BEGIN,END,FAIL


######## Variant calling ########

#`GATK` (Genome Analysis ToolKit) properly pronounced "Gee-ay-tee-kay" (/dʒi•eɪ•ti•keɪ/) and not "Gat-kay" (/ɡæt•keɪ/) 
# has apparently similar performance to other variant callers. 
# 3 steps (following Sylvain Schmitt "Symcapture") 
# 1. Variant calling__ Run the `HaplotypeCaller` on each sample's BAM files to create single-sample gVCFs using the `.g.vcf` extension for the output file.
# 2. Data aggregation__ Aggregate the GVCF files and feed in one GVCF with `GenomicsDBImport` to be genotyped
# 3. Joint genotyping__ Run `GenotypeGVCFs` on all of them together to create the raw SNP and indel VCFs that are usually emitted by the callers.


#Clean work place 

module purge 

#Loading modules 

module load devel/python/Python-3.11.1 devel/java/17.0.6
module load bioinfo/GATK/4.2.6.1
module load bioinfo/samtools/1.19


###Index bamfiles### 
cd ~/work/Dicorynia/test_subsamples/align_subsamples/
for bamFile in *.bam
do
    samtools index "$bamFile"
done



###HaplotypeCaller###
#HaplotypeCaller analyse les données de séquençage alignées (fichiers BAM ou CRAM) pour détecter les variations génétiques par rapport à une séquence de référence.
#Il reconstruit les haplotypes possibles dans une région donnée du génome et compare ensuite ces haplotypes à la séquence de référence pour identifier les variantes.
#HaplotypeCaller peut générer des fichiers Genomic VCF (gVCF), qui contiennent non seulement les variantes détectées mais aussi des informations sur les régions non variantes du génome.


#Se placer dans le fichier contenant les bam files 

cd ~/work/Dicorynia/test_subsamples/align_subsamples/

#Définir le dossier de sortie des fichiers

OUTPUT_DIR="/work/user/jbonnier/Dicorynia/test_subsamples/variants_calling/haplocall_gvcf/"

#Boucle

for bamFile in *.bam
do
    # Extraire le nom de base du fichier BAM sans extension
    baseName=$(basename "$bamFile" .bam)

    # Définir le chemin du fichier de sortie gVCF
    outputFile="${OUTPUT_DIR}/${baseName}.g.vcf.gz"
	
 # Exécuter GATK HaplotypeCaller
    echo "Traitement de $bamFile"
    gatk --java-options "-Xmx4g" HaplotypeCaller \
         -R ~/work/Dicorynia/Raw_data/Dgu_HS1_HYBRID_SCAFFOLD.fa \
         -I "$bamFile" \
         -O "$outputFile" \
         -ERC GVCF
done


#test
