#!/bin/bash
#SBATCH -p workq
#SBATCH --time=20:00:00 #job time limit
#SBATCH -J 07.1.2-nucleotide_divesity #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=30G #memory reservation
#SBATCH --cpus-per-task=10 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL


echo "Starting nucleotide diversity calculation"

# Clean the work environment
module purge

#Module load
module load bioinfo/samtools/1.14
module load bioinfo/VCFtools/0.1.16
module load bioinfo/Bcftools/1.9

# Define the path
FULL_VCF="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-sweep_processing_01/07.1.1-Fst_windows/filtered_FST_5percent_snps.vcf"
FILE_East="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-sweep_processing_01/07.1.1-Fst_windows/East_pop.txt"
FILE_West="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-sweep_processing_01/07.1.1-Fst_windows/West_pop.txt"
OUTPUT_DIR="/work/user/jbonnier/Dicorynia/full_workflow/07-population_genomic/07.1-sweep_processing_01/07.1.1-nucleotide_diversity/"


# Split the full VCF into two files for East and West populations
vcftools --vcf $FULL_VCF --keep $FILE_East --recode --recode-INFO-all --out ${OUTPUT_DIR}/East_FST_filtered
vcftools --vcf $FULL_VCF --keep $FILE_West --recode --recode-INFO-all --out ${OUTPUT_DIR}/West_FST_filtered

# Update the VCF_FILE paths to the newly created files
VCF_FILE_EAST="${OUTPUT_DIR}/East_FST_filtered.recode.vcf"
VCF_FILE_WEST="${OUTPUT_DIR}/West_FST_filtered.recode.vcf"



# Compress and index the new VCF files
vcf-sort $VCF_FILE_EAST > ${VCF_FILE_EAST}.sorted.vcf
bgzip -c ${VCF_FILE_EAST}.sorted.vcf > ${VCF_FILE_EAST}.sorted.vcf.gz
tabix -p vcf ${VCF_FILE_EAST}.sorted.vcf.gz

vcf-sort $VCF_FILE_WEST > ${VCF_FILE_WEST}.sorted.vcf
bgzip -c ${VCF_FILE_WEST}.sorted.vcf > ${VCF_FILE_WEST}.sorted.vcf.gz
tabix -p vcf ${VCF_FILE_WEST}.sorted.vcf.gz

# Calcul de la diversité nucléotidique pour la population de l'Est
vcftools --gzvcf $VCF_FILE_EAST.sorted.vcf.gz\
    --window-pi 100000 \
    --window-pi-step 10000 \
    --out ${OUTPUT_DIR}/nucleotide_diversity_east

# Calcul de la diversité nucléotidique pour la population de l'Ouest
vcftools --gzvcf $VCF_FILE_WEST.sorted.vcf.gz \
    --window-pi 100000 \
    --window-pi-step 10000 \
    --out ${OUTPUT_DIR}/nucleotide_diversity_west
	
