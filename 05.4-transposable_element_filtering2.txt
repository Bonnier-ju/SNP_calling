#!/bin/bash
#SBATCH -p workq
#SBATCH --time=10:00:00 #job time limit
#SBATCH -J 05.4-transposable_element_filtering2 #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=20G #memory reservation
#SBATCH --cpus-per-task=8 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL

echo "Starting transposable element filtering"

# Clean the work environment
module purge
module load bioinfo/BEDOPS/2.4.41
module load bioinfo/Bcftools/1.9
module load bioinfo/PLINK/2.00a4 
module load devel/python/Python-3.11.1
module load bioinfo/bedtools/2.30.0

# Define file paths
GENOME_GFF_FILE="/work/user/jbonnier/Dicorynia/Raw_data/Dgu_HS1_HYBRID_SCAFFOLD.fa.out.gff.gz"
GENOME_TE_FILE="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.4-transposable_element_filtering/transposable_elements.bed"
SNP_FILE="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.4-transposable_element_filtering/bedtool_file_SNP.bed"
OUTPUT_PREFIX="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.4-transposable_element_filtering/"
BINARY_FILES_PREFIX="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.3-missing_filtering/missing_filtered"

echo "Converting GFF to BED..."
zcat $GENOME_GFF_FILE | gff2bed > $GENOME_TE_FILE
echo "Conversion from GFF to BED completed."

echo "Filtering SNPs based on transposable elements..."
bedtools intersect -a $SNP_FILE -b $GENOME_TE_FILE -wa > ${OUTPUT_PREFIX}filtered_snps.bed


# Count the number of SNPs in transposable elements
echo "Counting SNPs in transposable elements..."
SNP_COUNT=$(wc -l < ${OUTPUT_PREFIX}filtered_snps.bed)
echo "There are ${SNP_COUNT} SNPs in transposable elements."


echo "Generating PLINK-readable list from filtered SNPs..."
awk '{print $4}' ${OUTPUT_PREFIX}filtered_snps.bed > ${OUTPUT_PREFIX}filtered_snps_list.txt

echo "Creating binary files with PLINK..."
plink2 --bfile $BINARY_FILES_PREFIX --extract ${OUTPUT_PREFIX}filtered_snps_list.txt --make-bed --allow-extra-chr --out ${OUTPUT_PREFIX}filtered_TE_output

echo "Transposable element filtering completed."
