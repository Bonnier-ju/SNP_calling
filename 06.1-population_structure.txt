#!/bin/bash
#SBATCH -p unlimitq 
#SBATCH --time=250:00:00 #job time limit
#SBATCH -J 06.1-population_structure #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=60G #memory reservation
#SBATCH --cpus-per-task=12 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL



##### Population structure analysis #####
#########################################

echo "Starting Population structure analysis"

# Cleaning work place 
module purge

# Load the necessary modules
module load bioinfo/PLINK/2.00a4 
module load bioinfo/ADMIXTURE/1.3.0

# Define paths
BINARY_FILES_PREFIX="/work/user/jbonnier/Dicorynia/full_workflow/06-population_genetic/06.2-LD_allele_freq/wind_100000/LD_files"
ADMIXTURE_OUTPUT="/work/user/jbonnier/Dicorynia/full_workflow/06-population_genetic/06.1-admixture/wind_100000/"

# Renaming chromosomes in .bim file to make it compatible with ADMIXTURE
echo "Renaming chromosomes in .bim file..."
awk '{$1="0"; print}' ${BINARY_FILES_PREFIX}.bim > ${BINARY_FILES_PREFIX}_temp.bim
mv ${BINARY_FILES_PREFIX}_temp.bim ${BINARY_FILES_PREFIX}.bim

echo "Running ADMIXTURE..."

for K in {1..12}; do
    admixture --cv ${BINARY_FILES_PREFIX}.bed $K | tee ${ADMIXTURE_OUTPUT}/log${K}.out
    echo "ADMIXTURE analysis for K=${K} is completed."
done

echo "End of ADMIXTURE processing, let's see the results"