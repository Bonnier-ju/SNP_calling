#!/bin/bash
#SBATCH -p unlimitq 
#SBATCH --time=150:00:00 #job time limit
#SBATCH -J 06.1-Admixture #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=80G #memory reservation
#SBATCH --cpus-per-task=25 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL

##### Population structure analysis with ADMIXTURE #####
########################################################

echo "Starting Population structure analysis"

# Cleaning work place 
module purge

# Load the necessary modules
module load bioinfo/PLINK/1.90b7
module load bioinfo/ADMIXTURE/1.3.0

# Define paths
VCF_INPUT="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.5-LD-filtering/05.5.3-LD_04_pruned/ld_04_pruned.vcf"
BINARY_FILES="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.5-LD-filtering/05.5.3-LD_04_pruned/ld_04_pruned"
ADMIXTURE_OUTPUT="/work/user/jbonnier/Dicorynia/full_workflow/06-population_structure/06.1-admixture/full_SNP_04_pruned/"


# Step 1: Converting VCF to binary files
echo "Converting VCF to binary files and excluding specific individuals..."
plink --vcf $VCF_INPUT \
	--make-bed \
	--allow-extra-chr \
 --const-fid \
	--out $BINARY_FILES

# Step 2: Renaming chromosomes in .bim file to make it compatible with ADMIXTURE
echo "Renaming chromosomes in .bim file..."
awk '{$1="0"; print}' ${BINARY_FILES}.bim > ${BINARY_FILES}_temp.bim
mv ${BINARY_FILES}_temp.bim ${BINARY_FILES}.bim

# Move to ADMIXTURE directory
cd /work/user/jbonnier/Dicorynia/full_workflow/06-population_structure/06.1-admixture/full_SNP_04_pruned/

# Step 3: Running ADMIXTURE
echo "Running ADMIXTURE..."
for K in {1..10}; do
    admixture --cv=100 $BINARY_FILES.bed $K | tee ${ADMIXTURE_OUTPUT}/log${K}.out
    echo "ADMIXTURE analysis for K=${K} is completed."
done

echo "End of ADMIXTURE processing, let's see the results"

# Step 4: Collect the cross-validation information obtained from all the log files
grep -h CV log*.out > cross_validation.txt


# Associating individual names with ADMIXTURE results
echo "Associating individual names with ADMIXTURE results..."
awk '{print $2}' $BINARY_FILES.fam > ${ADMIXTURE_OUTPUT}/individual_ids.txt
for K in {1..10}; do
    paste ${ADMIXTURE_OUTPUT}/individual_ids.txt ${ADMIXTURE_OUTPUT}/ld_04_pruned.${K}.Q > ${ADMIXTURE_OUTPUT}/ld_04_pruned.${K}.named.Q
    echo "Created named result file for K=${K}."
done

echo "All processes completed."

