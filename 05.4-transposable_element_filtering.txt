#!/bin/bash
#SBATCH -p workq
#SBATCH --time=10:00:00 #job time limit
#SBATCH -J 05.4-transposable_element_filtering #job name
#SBATCH -o /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/output/output-%x-%j.out #output file name
#SBATCH -e /work/user/jbonnier/Dicorynia/full_workflow/00-batch_scripts/error/error-%x-%j.out #error file name
#SBATCH --mem=20G #memory reservation
#SBATCH --cpus-per-task=8 #ncpu on the same node
#SBATCH --mail-user=julien.bonnier@ecofog.gf 
#SBATCH --mail-type=END,FAIL

##### Transposable element filtering #####

echo "Starting transposable element filtering"

# Clean the work environment
module purge
module load bioinfo/BEDOPS/2.4.41
module load bioinfo/Bcftools/1.9
module load bioinfo/PLINK/2.00a4 
module load devel/python/Python-3.11.1
module load bioinfo/bedtools/2.30.0

# Define file paths
GENOME_GFF_FILE="/work/user/jbonnier/Dicorynia/Raw_data/Dgu_HS1_HYBRID_SCAFFOLD.fa.out.gff.gz"
TE_BED_FILE="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.4-transposable_element_filtering/transposable_elements.bed"
FILTER_SNP="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.4-transposable_element_filtering/filtered_SNP.bed"
OUTPUT_TE_FILTER_PREFIX="/work/user/jbonnier/Dicorynia/full_workflow/05-filtering_variants/05.4-transposable_element_filtering/snp_in_te_filtered.bed"

# Convert GFF to BED
echo "Converting GFF to BED..."
zcat $GENOME_GFF_FILE | gff2bed > $TE_BED_FILE
echo "Conversion from GFF to BED completed."


# Filter SNPs based on transposable elements using bedtools
echo "Filtering SNPs based on transposable elements..."
bedtools intersect \
    -a ${FILTER_SNP} \
    -b ${TE_BED_FILE} > ${OUTPUT_TE_FILTER_PREFIX}
echo "Filtering SNPs based on transposable elements completed."


# Count the number of SNPs in transposable elements
echo "Counting SNPs in transposable elements..."
SNP_COUNT=$(wc -l < ${OUTPUT_TE_FILTER_PREFIX})
echo "There are ${SNP_COUNT} SNPs in transposable elements."